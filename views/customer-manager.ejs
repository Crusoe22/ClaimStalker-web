<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Customer Manager | ClaimStalker</title>
    <link rel="stylesheet" href="/customer-manager.css">
</head>

<body>

<div class="container">
    <h1>Customer Manager</h1>

    <!-- MODE SWITCH -->
    <div class="mode-switch">
        <button id="modeCreateBtn" class="active" onclick="switchMode('create')">Add Customer</button>
        <button id="modeSearchBtn" onclick="switchMode('search')">Search / Update Customers</button>
    </div>

    <!-- ======================================================
         SEARCH / UPDATE SECTION
    ====================================================== -->
    <div id="searchSection" class="hidden">

        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search by Customer ID, Last Name, or Email">
            <button onclick="searchCustomers()">Search</button>
        </div>

        <!-- Excel-like results -->
        <table id="resultsTable" class="excel-table hidden">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Agency</th>
                    <th>First</th>
                    <th>Last</th>
                    <th>Phone</th>
                    <th>Email</th>
                    <th>City</th>
                    <th>State</th>
                </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
        </table>

        <p id="noResults" class="hidden">No customers found.</p>

        <hr>
    </div>


    <!-- ======================================================
         CREATE / UPDATE FORM
    ====================================================== -->

    <form id="customerForm">
        <h2 id="formTitle">Create New Customer</h2>

        <input type="hidden" id="customer_id">

        <label>Agency ID</label>
        <input type="number" id="agency_id" required>

        <label>First Name</label>
        <input type="text" id="first_name" required>

        <label>Last Name</label>
        <input type="text" id="last_name" required>

        <label>Phone Number</label>
        <input type="text" id="phone_number">

        <label>Email</label>
        <input type="email" id="email">

        <label>Address Line 1</label>
        <input type="text" id="address_line1" required>

        <label>Address Line 2</label>
        <input type="text" id="address_line2">

        <label>City</label>
        <input type="text" id="city" required>

        <label>State</label>
        <input type="text" id="state" required>

        <label>Zip Code</label>
        <input type="text" id="zip_code" required>

        <button type="button" onclick="submitCustomer()">Submit</button>
        <button type="button" class="clear-btn" onclick="clearForm()">Clear</button>
    </form>

</div>


<script>

// ========================================================
// Mode switching between Create & Search
// ========================================================
function switchMode(mode) {
    const createBtn = document.getElementById("modeCreateBtn");
    const searchBtn = document.getElementById("modeSearchBtn");
    const searchSection = document.getElementById("searchSection");
    const formTitle = document.getElementById("formTitle");

    if (mode === "create") {
        createBtn.classList.add("active");
        searchBtn.classList.remove("active");
        searchSection.classList.add("hidden");
        clearForm();
        formTitle.innerText = "Create New Customer";
    } else {
        searchBtn.classList.add("active");
        createBtn.classList.remove("active");
        searchSection.classList.remove("hidden");
        formTitle.innerText = "Update Customer";
    }
}


// ========================================================
// Search customers (returns multiple rows)
// ========================================================
function searchCustomers() {
    const query = document.getElementById("searchInput").value.trim();

    fetch(`/customers/search-multiple?query=${query}`)
        .then(res => res.json())
        .then(data => {

            const table = document.getElementById("resultsTable");
            const tbody = document.getElementById("resultsBody");
            const noResults = document.getElementById("noResults");

            tbody.innerHTML = "";

            if (!data.success || data.customers.length === 0) {
                table.classList.add("hidden");
                noResults.classList.remove("hidden");
                return;
            }

            noResults.classList.add("hidden");
            table.classList.remove("hidden");

            data.customers.forEach(c => {
                const row = document.createElement("tr");

                row.innerHTML = `
                    <td>${c.customer_id}</td>
                    <td>${c.agency_id}</td>
                    <td>${c.first_name}</td>
                    <td>${c.last_name}</td>
                    <td>${c.phone_number || ""}</td>
                    <td>${c.email || ""}</td>
                    <td>${c.city}</td>
                    <td>${c.state}</td>
                `;

                // When clicking a row, load data into form
                row.onclick = () => loadCustomerIntoForm(c);

                tbody.appendChild(row);
            });
        });
}


// ========================================================
// Load selected row into the form for editing
// ========================================================
function loadCustomerIntoForm(c) {
    document.getElementById("customer_id").value = c.customer_id;
    document.getElementById("agency_id").value = c.agency_id;
    document.getElementById("first_name").value = c.first_name;
    document.getElementById("last_name").value = c.last_name;
    document.getElementById("phone_number").value = c.phone_number || "";
    document.getElementById("email").value = c.email || "";
    document.getElementById("address_line1").value = c.address_line1;
    document.getElementById("address_line2").value = c.address_line2 || "";
    document.getElementById("city").value = c.city;
    document.getElementById("state").value = c.state;
    document.getElementById("zip_code").value = c.zip_code;

    document.getElementById("formTitle").innerText = "Update Customer";
}


// ========================================================
// Save customer (create or update)
// ========================================================
function submitCustomer() {

    const payload = {
        customer_id: document.getElementById("customer_id").value || null,
        agency_id: document.getElementById("agency_id").value,
        first_name: document.getElementById("first_name").value,
        last_name: document.getElementById("last_name").value,
        phone_number: document.getElementById("phone_number").value,
        email: document.getElementById("email").value,
        address_line1: document.getElementById("address_line1").value,
        address_line2: document.getElementById("address_line2").value,
        city: document.getElementById("city").value,
        state: document.getElementById("state").value,
        zip_code: document.getElementById("zip_code").value
    };

    fetch("/customers/save", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        alert(data.message);

        // Reset only when creating
        if (data.success && !payload.customer_id) {
            clearForm();
        }
    });
}


// ========================================================
// Clear form
// ========================================================
function clearForm() {
    document.getElementById("customerForm").reset();
    document.getElementById("customer_id").value = "";
    document.getElementById("formTitle").innerText = "Create New Customer";
}

</script>

</body>
</html>
